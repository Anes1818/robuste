<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta name="description" content="Robuste eulma - Produits électroménagers de haute qualité avec garantie et livraison rapide en Algérie">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Favicon -->
<link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">

<!-- Theme color -->
<meta name="theme-color" content="#FF6B35">
<title>Robuste eulma - Produit</title>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

<!-- Bootstrap RTL -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<!-- Lien vers le fichier CSS principal -->
<link rel="stylesheet" href="style.css">

<!-- أسلوب صفحة المنتج المتوافق مع style.css -->
<style>
    /* المتغيرات موجودة بالفعل في style.css */

    body {
        background-color: var(--secondary);
        color: var(--dark);
        padding-top: 56px;
    }

    /* ============== تحسينات وضع الظلام ============== */
    [data-theme="dark"] .product-section {
        background-color: #121212;
    }

    [data-theme="dark"] .product-card {
        background: var(--light);
        border: 1px solid var(--border-color);
    }

    [data-theme="dark"] .product-details {
        background: var(--light);
        border: 1px solid var(--border-color);
    }

    /* ============== تصميم صفحة المنتج ============== */
    .product-section {
        padding: 60px 0;
        background-color: var(--secondary);
    }

    .product-container {
        display: flex;
        gap: 40px;
        margin-bottom: 60px;
        flex-wrap: wrap;
    }

    /* معرض الصور */
    .product-gallery {
        flex: 1;
        min-width: 300px;
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border: 1px solid var(--border-color);
    }

    .main-image-container {
        position: relative;
        height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
    }

    .main-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        transition: transform 0.3s ease;
    }

    .thumbnail-container {
        display: flex;
        gap: 15px;
        overflow-x: auto;
        padding: 15px 0;
    }

    .thumbnail {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        flex-shrink: 0;
        border: 1px solid var(--border-color);
        background: white;
    }

    .thumbnail.active {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
    }

    .thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* تفاصيل المنتج */
    .product-details {
        flex: 1;
        min-width: 300px;
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border: 1px solid var(--border-color);
    }

    .product-title {
        font-size: 1.8rem;
        font-weight: 800;
        margin-bottom: 15px;
        color: var(--dark);
        line-height: 1.3;
    }

    .product-rating {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    .stars {
        color: #FFA41C;
        font-size: 1.2rem;
    }

    .rating-count {
        color: var(--gray);
        font-size: 0.9rem;
    }

    .price-section {
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
    }

    .current-price {
        font-size: 2.2rem;
        font-weight: 800;
        color: var(--primary);
        margin-bottom: 5px;
    }

    .old-price {
        font-size: 1.2rem;
        color: var(--gray);
        text-decoration: line-through;
        margin-left: 10px;
    }

    .discount-badge {
        display: inline-block;
        background: var(--danger);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.9rem;
        font-weight: 700;
        margin-right: 10px;
    }

    .product-description {
        font-size: 1.1rem;
        line-height: 1.6;
        color: var(--gray);
        margin-bottom: 25px;
    }

    .features-list {
        margin: 25px 0;
    }

    .features-list li {
        margin-bottom: 10px;
        padding-right: 25px;
        position: relative;
        font-size: 1rem;
        line-height: 1.5;
        color: var(--dark);
    }

    .features-list li:before {
        content: "✓";
        position: absolute;
        right: 0;
        color: var(--success);
        font-weight: bold;
        font-size: 1.2rem;
    }

    .stock-status {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 25px 0;
        padding: 15px;
        background: rgba(40, 167, 69, 0.1);
        border-radius: 10px;
        border: 1px solid rgba(40, 167, 69, 0.2);
    }

    .stock-status.in-stock i {
        color: var(--success);
    }

    .stock-status.out-of-stock {
        background: rgba(220, 53, 69, 0.1);
        border-color: rgba(220, 53, 69, 0.2);
    }

    .stock-status.out-of-stock i {
        color: var(--danger);
    }

    /* أزرار الإجراء */
    .action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 30px;
    }

    .btn-product {
        background: var(--primary);
        border: none;
        border-radius: 10px;
        padding: 15px;
        font-size: 1.1rem;
        font-weight: 700;
        color: white;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        min-height: 52px;
        text-align: center;
    }

    .btn-product:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .btn-product-secondary {
        background: white;
        color: var(--primary);
        border: 2px solid var(--primary);
    }

    .btn-product-secondary:hover {
        background: var(--primary);
        color: white;
    }

    /* معلومات الشحن */
    .shipping-info {
        margin-top: 30px;
        padding: 25px;
        background: rgba(248, 249, 250, 0.8);
        border-radius: 10px;
        border: 1px solid var(--border-color);
    }

    [data-theme="dark"] .shipping-info {
        background: rgba(255, 255, 255, 0.05);
    }

    .shipping-info .item {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
    }

    .shipping-info .item i {
        color: var(--primary);
        font-size: 1.3rem;
        min-width: 24px;
    }

    /* قسم المنتجات المشابهة */
    .related-products {
        margin-top: 60px;
        padding-top: 40px;
        border-top: 1px solid var(--border-color);
    }

    .section-title {
        position: relative;
        margin-bottom: 40px;
        padding-bottom: 15px;
        font-weight: 800;
        color: var(--dark);
        text-align: center;
        font-size: 1.8rem;
    }

    .section-title::after {
        content: '';
        position: absolute;
        bottom: 0;
        right: 50%;
        transform: translateX(50%);
        width: 80px;
        height: 4px;
        background-color: var(--primary);
        border-radius: 2px;
    }

    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 25px;
        margin-top: 30px;
    }

    /* ============== تصميم متجاوب ============== */
    @media (max-width: 992px) {
        .product-container {
            flex-direction: column;
        }

        .main-image-container {
            height: 350px;
        }

        .product-title {
            font-size: 1.6rem;
        }

        .current-price {
            font-size: 1.9rem;
        }

        .action-buttons {
            grid-template-columns: 1fr;
        }

        .products-grid {
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .main-image-container {
            height: 300px;
        }

        .product-title {
            font-size: 1.4rem;
        }

        .current-price {
            font-size: 1.7rem;
        }

        .product-details {
            padding: 20px;
        }

        .products-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
    }

    @media (max-width: 576px) {
        .main-image-container {
            height: 250px;
        }

        .thumbnail {
            width: 60px;
            height: 60px;
        }

        .products-grid {
            grid-template-columns: 1fr;
        }

        .product-title {
            font-size: 1.3rem;
        }

        .current-price {
            font-size: 1.5rem;
        }
    }

    /* تحسينات إضافية للهاتف */
    @media (max-width: 768px) {
        .product-section {
            padding: 40px 0;
        }

        .product-gallery,
        .product-details {
            padding: 20px;
        }

        .features-list li {
            font-size: 0.95rem;
        }

        .btn-product {
            min-height: 48px;
            font-size: 1rem;
            padding: 12px;
        }
    }

    @media (max-width: 576px) {
        .product-section {
            padding: 30px 0;
        }

        .action-buttons {
            gap: 10px;
        }
    }
</style>
</head>

<body>
    <!-- شريط التنقل -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="https://i.postimg.cc/7P7BK44r/f525e1dd-9f2c-4160-aed1-882a8b28b75c-20250703-131500-0000.png" 
                     alt="Robuste Logo" class="d-inline-block align-top" 
                     style="width: 150px; height: auto; max-height: 40px; object-fit:fill;">
                <span class="d-none d-lg-inline fw-bold fs-4 ms-2" style="color: #FF6B35;">ROBUSTE eulma</span>
            </a>
            
            <!-- زر دارك مود -->
            <div class="d-flex align-items-center me-3">
                <button class="theme-toggle" id="themeToggle" title="Mode sombre/clair">
                    <i class="bi bi-moon"></i>
                </button>
            </div>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item mx-2"><a class="nav-link" href="index.html">Accueil</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#products">Produits</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#reviews">Avis clients</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#contact">Contact</a></li>
                </ul>
            </div>
            
            <!-- أيقونة السلة مع عداد -->
            <div class="cart-icon-container ms-lg-4">
                <a href="#" class="cart-btn position-relative" onclick="toggleCart(); return false;">
                    <i class="bi bi-cart3"></i>
                    <span class="position-absolute badge rounded-pill bg-danger" id="cartCount">0</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- مؤشر الحالة -->
    <div class="status-indicator" id="statusIndicator" style="display: none;">
        <div class="alert alert-dismissible fade show" role="alert">
            <span id="statusMessage"></span>
            <button type="button" class="btn-close" onclick="hideStatus()"></button>
        </div>
    </div>

    <!-- قسم المنتج الرئيسي -->
    <section class="product-section">
        <div class="container">
            <div class="product-container" id="productContainer">
                <!-- سيتم تعبئته بواسطة JavaScript -->
                <div class="text-center py-5 w-100">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-3">Chargement des détails du produit...</p>
                </div>
            </div>

            <!-- المنتجات المشابهة -->
            <div class="related-products">
                <h2 class="section-title">Produits similaires</h2>
                <div class="products-grid" id="relatedProductsContainer">
                    <!-- سيتم تعبئته بواسطة JavaScript -->
                </div>
            </div>
        </div>
    </section>

    <!-- فوتر -->
    <footer class="py-5 bg-dark text-white">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <h5 class="mb-3">À propos de ROBUSTE</h5>
                    <p>Magasin spécialisé dans les appareils électroménagers de haute qualité à des prix compétitifs. Nous offrons les meilleurs produits et une livraison rapide.</p>
                    <div class="mt-3">
                        <a href="https://www.facebook.com/share/19QooaXfy8/" class="social-icon" target="_blank">
                            <i class="bi bi-facebook"></i>
                        </a>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 mb-4">
                    <h5 class="mb-3">Liens rapides</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="index.html" class="text-white text-decoration-none">Accueil</a></li>
                        <li class="mb-2"><a href="index.html#products" class="text-white text-decoration-none">Produits</a></li>
                        <li class="mb-2"><a href="index.html#reviews" class="text-white text-decoration-none">Avis clients</a></li>
                        <li class="mb-2"><a href="index.html#contact" class="text-white text-decoration-none">Contact</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-4 mb-4">
                    <h5 class="mb-3">Service client</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="#" class="text-white text-decoration-none">FAQ</a></li>
                        <li class="mb-2"><a href="#" class="text-white text-decoration-none">Modes de paiement</a></li>
                        <li class="mb-2"><a href="#" class="text-white text-decoration-none">Conditions de garantie</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-4 mb-4">
                    <h5 class="mb-3">Suivez notre page</h5>
                    <p>Abonnez-vous pour recevoir les dernières offres et réductions</p>
                    <div class="mt-3">
                        <a href="https://www.facebook.com/share/19QooaXfy8/" class="btn btn-orange w-100" target="_blank">
                            S'abonner maintenant
                        </a>
                    </div>
                </div>
            </div>
            <hr class="my-4 bg-light">
            <div class="row">
                <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                    <p class="mb-0">&copy; 2025 ROBUSTE. Tous droits réservés.</p>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <div class="d-flex flex-column flex-md-row align-items-center justify-content-md-end">
                        <p class="mb-2 mb-md-0 me-md-3">Paiement par carte dorée disponible</p>
                        <img src="https://i.postimg.cc/bY06X2YN/logo-round.png" alt="Modes de paiement" style="width: 30px; height: auto;">
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- زر واتساب -->
    <a href="https://wa.me/213656360457" class="whatsapp-btn" target="_blank">
        <i class="bi bi-whatsapp"></i>
    </a>

    <!-- سلة المشتريات -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas" aria-labelledby="cartOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="cartOffcanvasLabel">Panier</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
        </div>
        <div class="offcanvas-body">
            <div id="cartItems" class="mb-3">
                <!-- سيتم تعبئته بواسطة JavaScript -->
                <div class="text-center py-4 text-muted" id="emptyCartMessage">
                    <i class="bi bi-cart-x display-4 d-block mb-2"></i>
                    Le panier est vide
                </div>
            </div>
            
            <div class="cart-summary border-top pt-3">
                <div class="d-flex justify-content-between mb-2">
                    <span>Total:</span>
                    <span id="cartTotal">0 DA</span>
                </div>
                <button class="btn btn-orange w-100" onclick="checkout()" id="checkoutBtn" disabled>
                    <i class="bi bi-bag-check"></i> Passer la commande
                </button>
            </div>
        </div>
    </div>

    <!-- نموذج الطلب السريع -->
    <div class="modal fade" id="quickOrderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Commande rapide</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <div class="order-summary mb-4">
                        <h6 class="mb-3">Résumé de la commande</h6>
                        <div class="d-flex align-items-center">
                            <img id="quickOrderProductImage" class="product-image-thumb me-3" src="" alt="Image du produit">
                            <div>
                                <h5 id="quickOrderProductName" class="mb-1"></h5>
                                <p id="quickOrderProductPrice" class="mb-0 text-primary fw-bold"></p>
                            </div>
                        </div>
                    </div>
                    
                    <form id="quickOrderForm">
                        <input type="hidden" id="quickOrderProductId">
                        <input type="hidden" id="quickOrderProductPriceValue">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="quickOrderFullName" class="form-label">Nom complet <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="quickOrderFullName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="quickOrderPhone" class="form-label">Numéro de téléphone <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="quickOrderPhone" pattern="[0]{1}[5-7]{1}[0-9]{8}" required>
                                <small class="text-muted">Exemple: 0551234566</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="quickOrderEmail" class="form-label">Email (optionnel)</label>
                                <input type="email" class="form-control" id="quickOrderEmail">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="quickOrderWilaya" class="form-label">Wilaya <span class="text-danger">*</span></label>
                                <select class="form-select" id="quickOrderWilaya" required>
                                    <option value="">Choisissez votre wilaya</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="quickOrderAddress" class="form-label">Adresse de livraison</label>
                            <textarea class="form-control" id="quickOrderAddress" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-orange" id="submitQuickOrderBtn" onclick="submitQuickOrder()">
                        Confirmer la commande
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- السكريبتات -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBTrnKCYOtfSSDYtmVQbzP2HcwgkLT565Y",
            authDomain: "robuste-c8e0f.firebaseapp.com",
            projectId: "robuste-c8e0f",
            storageBucket: "robuste-c8e0f.appspot.com",
            messagingSenderId: "975609984963",
            appId: "1:975609984963:web:a481efb493a88d7bc7af76",
            measurementId: "G-DWT7MZN028"
        };

        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // تهيئة EmailJS
        (function() {
            emailjs.init("k77vdaUWPpnLrfTnS");
        })();

        // ============== المتغيرات العامة ==============
        let cart = [];
        let currentProduct = null;
        let relatedProducts = [];

        // ============== إدارة السلة (متوافقة مع main.js) ==============

        // تحميل السلة من localStorage
        function loadCart() {
            try {
                const cartData = localStorage.getItem('robuste_cart');
                if (cartData) {
                    cart = JSON.parse(cartData);
                }
            } catch (e) {
                console.error('Erreur de chargement du panier:', e);
                cart = [];
            }
            updateCartCount();
            renderCart();
        }

        // تحديث عداد السلة
        function updateCartCount() {
            const cartCount = document.getElementById('cartCount');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (!cartCount || !checkoutBtn) return;
            
            const count = cart.reduce((total, item) => total + (item.quantity || 0), 0);
            cartCount.textContent = count;
            checkoutBtn.disabled = count === 0;
        }

        // عرض محتويات السلة
        function renderCart() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            if (!cartItems || !cartTotal) return;
            
            // مسح المحتوى الحالي
            while (cartItems.firstChild) {
                cartItems.removeChild(cartItems.firstChild);
            }
            
            if (cart.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'text-center py-4 text-muted';
                emptyDiv.id = 'emptyCartMessage';
                emptyDiv.innerHTML = '<i class="bi bi-cart-x display-4 d-block mb-2"></i>Le panier est vide';
                cartItems.appendChild(emptyDiv);
                cartTotal.textContent = '0 DA';
                return;
            }
            
            let total = 0;
            cart.forEach((item, index) => {
                const itemTotal = (item.price || 0) * (item.quantity || 0);
                total += itemTotal;
                
                const itemElement = document.createElement('div');
                itemElement.className = 'cart-item';
                itemElement.dataset.id = item.id || '';
                
                itemElement.innerHTML = `
                    <div class="d-flex">
                        <img src="${item.image || ''}" alt="${item.name || 'Produit'}" 
                             style="width: 80px; height: 80px; object-fit: contain; border-radius: 8px; background-color: #f8f8f8; padding: 5px;">
                        <div class="cart-item-details ms-3">
                            <div class="cart-item-title fw-bold">${item.name || 'Produit sans nom'}</div>
                            <div class="cart-item-price text-primary fw-bold">${item.price || 0} DA</div>
                            <div class="quantity-controls d-flex align-items-center mt-2">
                                <button class="btn btn-sm btn-outline-secondary" onclick="updateCartQuantity(${index}, ${item.quantity - 1})">-</button>
                                <span class="mx-2">${item.quantity || 1}</span>
                                <button class="btn btn-sm btn-outline-secondary" onclick="updateCartQuantity(${index}, ${item.quantity + 1})">+</button>
                                <button class="btn btn-sm btn-outline-danger me-2" onclick="removeFromCart(${index})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                cartItems.appendChild(itemElement);
            });
            
            cartTotal.textContent = `${total.toLocaleString('fr-FR')} DA`;
        }

        // تحديث كمية المنتج في السلة
        function updateCartQuantity(index, newQuantity) {
            if (isNaN(index) || index < 0 || index >= cart.length) return;
            
            if (newQuantity < 1) {
                removeFromCart(index);
                return;
            }
            
            cart[index].quantity = newQuantity;
            
            try {
                localStorage.setItem('robuste_cart', JSON.stringify(cart));
            } catch (e) {
                console.error('Erreur de mise à jour du panier:', e);
            }
            
            renderCart();
            updateCartCount();
        }

        // إزالة منتج من السلة
        function removeFromCart(index) {
            if (isNaN(index) || index < 0 || index >= cart.length) return;
            
            const productName = cart[index].name || 'Produit';
            cart.splice(index, 1);
            
            try {
                localStorage.setItem('robuste_cart', JSON.stringify(cart));
            } catch (e) {
                console.error('Erreur de mise à jour du panier:', e);
            }
            
            renderCart();
            updateCartCount();
            showStatus(`"${productName}" a été supprimé du panier`, 'success');
        }

        // إضافة منتج إلى السلة
        function addToCart(productName, productPrice, priceValue, productImages, productId) {
            const name = typeof productName === 'string' ? productName : 'Produit sans nom';
            const price = typeof priceValue === 'number' ? priceValue : 
                         typeof productPrice === 'number' ? productPrice : 0;
            const id = productId || Date.now().toString();
            
            let image = '';
            if (Array.isArray(productImages) && productImages.length > 0) {
                image = productImages[0];
            } else if (typeof productImages === 'string') {
                image = productImages;
            }
            
            const existingItemIndex = cart.findIndex(item => item.id === id);
            
            if (existingItemIndex >= 0) {
                cart[existingItemIndex].quantity += 1;
            } else {
                cart.push({
                    id: id,
                    name: name,
                    price: price,
                    image: image,
                    quantity: 1
                });
            }
            
            try {
                localStorage.setItem('robuste_cart', JSON.stringify(cart));
            } catch (e) {
                console.error('Erreur de sauvegarde du panier:', e);
                showStatus('Impossible de sauvegarder le panier, la mémoire peut être pleine', 'error');
            }
            
            updateCartCount();
            renderCart();
            
            showStatus(`"${name}" a été ajouté au panier`, 'success');
        }

        // إظهار/إخفاء السلة
        function toggleCart() {
            if (cart.length === 0) {
                showStatus('Le panier est vide', 'info');
                return;
            }
            
            try {
                const cartOffcanvas = new bootstrap.Offcanvas(document.getElementById('cartOffcanvas'));
                cartOffcanvas.show();
            } catch (e) {
                console.error('Erreur d\'ouverture du panier:', e);
                document.getElementById('cartOffcanvas').classList.add('show');
                document.body.classList.add('offcanvas-open');
            }
        }

        // إتمام عملية الشراء
        function checkout() {
            if (cart.length === 0) {
                showStatus('Le panier est vide', 'error');
                return;
            }
            
            // إخفاء سلة المشتريات
            const cartOffcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('cartOffcanvas'));
            if (cartOffcanvas) {
                cartOffcanvas.hide();
            }
            
            // توجيه إلى صفحة الطلب في الموقع الرئيسي
            window.location.href = 'index.html';
        }

        // ============== إدارة وضع الظلام ==============

        // تبديل وضع الظلام
        function toggleDarkMode() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            // تغيير السمة
            document.documentElement.setAttribute('data-theme', newTheme);
            
            // تحديث أيقونة الزر
            const themeIcon = document.querySelector('#themeToggle i');
            if (newTheme === 'dark') {
                themeIcon.className = 'bi bi-sun';
                themeIcon.parentElement.title = 'Activer le mode clair';
            } else {
                themeIcon.className = 'bi bi-moon';
                themeIcon.parentElement.title = 'Activer le mode sombre';
            }
            
            // حفظ التفضيل في localStorage
            localStorage.setItem('theme', newTheme);
        }

        // تهيئة وضع الظلام عند تحميل الصفحة
        function initDarkMode() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const themeIcon = document.querySelector('#themeToggle i');
            if (savedTheme === 'dark') {
                themeIcon.className = 'bi bi-sun';
                themeIcon.parentElement.title = 'Activer le mode clair';
            } else {
                themeIcon.className = 'bi bi-moon';
                themeIcon.parentElement.title = 'Activer le mode sombre';
            }
            
            // إضافة مستمع الحدث
            document.getElementById('themeToggle').addEventListener('click', toggleDarkMode);
        }

        // ============== تحميل وعرض المنتج ==============

        // تحميل بيانات المنتج
        async function loadProduct() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = parseInt(urlParams.get('pid'));
            
            if (!productId) {
                showProductError('ID du produit non spécifié');
                return;
            }
            
            try {
                const response = await fetch('products.json');
                
                if (!response.ok) {
                    throw new Error('Erreur de chargement des produits');
                }
                
                const products = await response.json();
                const product = products.find(p => p.id === productId);
                
                if (!product) {
                    showProductError('Produit non trouvé');
                    return;
                }
                
                currentProduct = product;
                renderProduct(product);
                loadRelatedProducts(product.category, product.id);
            } catch (error) {
                console.error('Erreur:', error);
                showProductError('Erreur de chargement du produit');
            }
        }

        // عرض المنتج
        function renderProduct(product) {
            const container = document.getElementById('productContainer');
            
            if (!container) return;
            
            // حساب نسبة الخصم
            const discountPercentage = product.old_price ? 
                Math.round(((product.old_price - product.price) / product.old_price) * 100) : 0;
            
            // إنشاء معرض الصور المصغرة
            const thumbnails = product.images.map((img, index) => `
                <div class="thumbnail ${index === 0 ? 'active' : ''}" onclick="changeMainImage('${img}', this)">
                    <img src="${img}" alt="Image ${index + 1}" loading="lazy">
                </div>
            `).join('');
            
            // إنشاء قائمة المميزات
            const featuresList = product.features ? product.features.map(feature => `
                <li>${feature}</li>
            `).join('') : '';
            
            container.innerHTML = `
                <div class="product-gallery">
                    <div class="main-image-container">
                        <img src="${product.images[0]}" alt="${product.title}" id="mainProductImage" class="main-image">
                    </div>
                    <div class="thumbnail-container">
                        ${thumbnails}
                    </div>
                </div>
                
                <div class="product-details">
                    <h1 class="product-title">${product.title}</h1>
                    
                    <div class="product-rating">
                        <div class="stars">
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-half"></i>
                        </div>
                        <span class="rating-count">(4.2) · 128 avis</span>
                    </div>
                    
                    <div class="price-section">
                        ${product.old_price ? `
                            <span class="discount-badge">-${discountPercentage}%</span>
                            <span class="old-price">${product.old_price.toLocaleString()} DA</span>
                        ` : ''}
                        <div class="current-price">${product.price.toLocaleString()} DA</div>
                    </div>
                    
                    <p class="product-description">${product.description || product.description_short || ''}</p>
                    
                    ${featuresList ? `
                    <div class="features-list">
                        <h5>Caractéristiques:</h5>
                        <ul>
                            ${featuresList}
                        </ul>
                    </div>
                    ` : ''}
                    
                    <div class="stock-status ${product.stock > 0 ? 'in-stock' : 'out-of-stock'}">
                        <i class="bi ${product.stock > 0 ? 'bi-check-circle-fill' : 'bi-x-circle-fill'}"></i>
                        <span>${product.stock > 0 ? `En stock (${product.stock} pièces)` : 'En rupture de stock'}</span>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn-product btn-product-secondary" onclick="addToCartFromPage()">
                            <i class="bi bi-cart-plus"></i> Ajouter au panier
                        </button>
                        <button class="btn-product" onclick="openQuickOrder()">
                            <i class="bi bi-lightning"></i> Acheter maintenant
                        </button>
                    </div>
                    
                    <div class="shipping-info">
                        <div class="item">
                            <i class="bi bi-truck"></i>
                            <span>Livraison gratuite pour les commandes supérieures à 5000 DA</span>
                        </div>
                        <div class="item">
                            <i class="bi bi-shield-check"></i>
                            <span>Garantie de deux ans</span>
                        </div>
                        <div class="item">
                            <i class="bi bi-arrow-clockwise"></i>
                            <span>Retour facile dans les 14 jours</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // تغيير الصورة الرئيسية
        function changeMainImage(src, element) {
            document.getElementById('mainProductImage').src = src;
            
            // إزالة النشط من جميع الصور المصغرة
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
            });
            
            // إضافة النشط للصورة المحددة
            element.classList.add('active');
        }

        // إضافة المنتج الحالي إلى السلة
        function addToCartFromPage() {
            if (!currentProduct) return;
            
            addToCart(
                currentProduct.title,
                `${currentProduct.price.toLocaleString()} DA`,
                currentProduct.price,
                currentProduct.images,
                currentProduct.id
            );
        }

        // ============== المنتجات المشابهة ==============

        // تحميل المنتجات المشابهة
        async function loadRelatedProducts(category, currentProductId) {
            try {
                const response = await fetch('products.json');
                const products = await response.json();
                
                // تصفية المنتجات بنفس الفئة عدا المنتج الحالي
                relatedProducts = products.filter(p => 
                    p.category === category && p.id !== currentProductId
                ).slice(0, 4); // أخذ أول 4 منتجات
                
                renderRelatedProducts();
            } catch (error) {
                console.error('Erreur de chargement des produits similaires:', error);
            }
        }

        // عرض المنتجات المشابهة
        function renderRelatedProducts() {
            const container = document.getElementById('relatedProductsContainer');
            
            if (!container) return;
            
            if (relatedProducts.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Aucun produit similaire</p>';
                return;
            }
            
            container.innerHTML = relatedProducts.map(product => {
                const discountBadge = product.old_price && product.old_price > product.price ? 
                    `<span class="badge bg-danger position-absolute" style="top: 10px; right: 10px;">
                        -${Math.round(((product.old_price - product.price) / product.old_price) * 100)}%
                    </span>` : '';
                
                const oldPrice = product.old_price && product.old_price > product.price ? 
                    `<div class="product-card-old-price">${product.old_price.toLocaleString()} DA</div>` : '';
                
                return `
                    <div class="product-card">
                        ${discountBadge}
                        <a href="product.html?pid=${product.id}" style="text-decoration: none; color: inherit;">
                            <div class="image-container">
                                <img src="${product.images[0]}" alt="${product.title}" loading="lazy" class="product-image">
                            </div>
                            <div class="product-info">
                                <h6 class="product-title">${product.title}</h6>
                                <div class="d-flex align-items-center">
                                    <div class="current-price">${product.price.toLocaleString()} DA</div>
                                    ${oldPrice}
                                </div>
                            </div>
                        </a>
                        <button class="buy-btn" onclick="event.stopPropagation(); addRelatedToCart(${product.id})">
                            <i class="bi bi-cart-plus"></i> Ajouter
                        </button>
                    </div>
                `;
            }).join('');
        }

        // إضافة منتج مشابه إلى السلة
        function addRelatedToCart(productId) {
            const product = relatedProducts.find(p => p.id === productId);
            
            if (product) {
                addToCart(
                    product.title,
                    `${product.price.toLocaleString()} DA`,
                    product.price,
                    product.images,
                    product.id
                );
            }
        }

        // ============== الطلب السريع ==============

        // فتح نموذج الطلب السريع
        function openQuickOrder() {
            if (!currentProduct) return;
            
            document.getElementById('quickOrderProductName').textContent = currentProduct.title;
            document.getElementById('quickOrderProductPrice').textContent = currentProduct.price.toLocaleString() + ' DA';
            document.getElementById('quickOrderProductImage').src = currentProduct.images[0];
            document.getElementById('quickOrderProductId').value = currentProduct.id;
            document.getElementById('quickOrderProductPriceValue').value = currentProduct.price;
            
            // تعبئة قائمة الولايات
            populateWilayas();
            
            const quickOrderModal = new bootstrap.Modal(document.getElementById('quickOrderModal'));
            quickOrderModal.show();
        }

        // تعبئة قائمة الولايات الجزائرية
        function populateWilayas() {
            const wilayas = [
                "Adrar", "Chlef", "Laghouat", "Oum El Bouaghi", "Batna", "Béjaïa", "Biskra", "Béchar", "Blida",
                "Bouira", "Tamanrasset", "Tébessa", "Tlemcen", "Tiaret", "Tizi Ouzou", "Alger", "Djelfa", "Jijel",
                "Sétif", "Saïda", "Skikda", "Sidi Bel Abbès", "Annaba", "Guelma", "Constantine", "Médéa", "Mostaganem",
                "M'Sila", "Mascara", "Ouargla", "Oran", "El Bayadh", "Illizi", "Bordj Bou Arreridj", "Boumerdès", "El Tarf",
                "Tindouf", "Tissemsilt", "El Oued", "Khenchela", "Souk Ahras", "Tipaza", "Mila", "Aïn Defla", "Naâma",
                "Aïn Témouchent", "Ghardaïa", "Relizane"
            ];
            
            const wilayaSelect = document.getElementById('quickOrderWilaya');
            wilayaSelect.innerHTML = '<option value="">Choisissez votre wilaya</option>';
            
            wilayas.forEach(wilaya => {
                const option = document.createElement('option');
                option.value = wilaya;
                option.textContent = wilaya;
                wilayaSelect.appendChild(option);
            });
        }

        // إرسال الطلب السريع
        async function submitQuickOrder() {
            const fullName = document.getElementById('quickOrderFullName').value;
            const phone = document.getElementById('quickOrderPhone').value;
            const email = document.getElementById('quickOrderEmail').value || 'Non fourni';
            const wilaya = document.getElementById('quickOrderWilaya').value;
            const address = document.getElementById('quickOrderAddress').value || 'Non spécifié';
            const productId = document.getElementById('quickOrderProductId').value;
            const productPrice = parseFloat(document.getElementById('quickOrderProductPriceValue').value);
            
            // التحقق من صحة البيانات
            if (!fullName || !phone || !wilaya) {
                showStatus('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            const phoneRegex = /^0[5-7][0-9]{8}$/;
            if (!phoneRegex.test(phone)) {
                showStatus('Numéro de téléphone incorrect. Doit comporter 10 chiffres et commencer par 05, 06 ou 07', 'error');
                return;
            }
            
            // إنشاء كائن المنتج للطلب
            const productItem = {
                id: productId,
                name: document.getElementById('quickOrderProductName').textContent,
                price: productPrice,
                image: document.getElementById('quickOrderProductImage').src,
                quantity: 1
            };
            
            // إعداد بيانات الطلب
            const orderData = {
                products: [productItem],
                customer: fullName,
                phone: phone,
                email: email,
                wilaya: wilaya,
                address: address,
                payment: 'Paiement à la livraison',
                totalPrice: productPrice,
                timestamp: new Date().toISOString(),
                status: 'Nouveau'
            };
            
            // عرض حالة التحميل
            showStatus('Traitement de votre commande...', 'loading');
            
            // تعطيل زر الإرسال أثناء المعالجة
            const submitBtn = document.getElementById('submitQuickOrderBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Traitement...
            `;
            
            try {
                // تخزين الطلب في Firebase
                const docRef = await db.collection('orders').add(orderData);
                console.log("Commande stockée dans Firebase:", docRef.id);
                
                // إرسال إيميل عبر EmailJS
                await emailjs.send("service_lc1q5k8", "template_a15g7yg", {
                    order_id: docRef.id,
                    customer_name: fullName,
                    customer_phone: phone,
                    customer_email: email,
                    wilaya: wilaya,
                    address: address,
                    total_price: productPrice.toLocaleString(),
                    payment_method: 'Paiement à la livraison',
                    order_date: new Date().toLocaleString('fr-FR'),
                    product_name: productItem.name
                });
                
                console.log("Email de confirmation envoyé");
                
                // عرض رسالة النجاح
                showStatus(`
                    <div class="text-center">
                        <i class="bi bi-check-circle-fill text-success fs-1"></i>
                        <h5 class="mt-2">Votre commande a été confirmée avec succès!</h5>
                        <div class="text-start mt-3">
                            <p><strong>Numéro de commande:</strong> ${docRef.id}</p>
                            <p><strong>Nom:</strong> ${fullName}</p>
                            <p><strong>Produit:</strong> ${productItem.name}</p>
                            <p><strong>Montant:</strong> ${productPrice.toLocaleString()} DA</p>
                            <p class="mt-3">Nous vous contacterons au <strong>${phone}</strong> dans les 24 heures pour confirmer la livraison.</p>
                        </div>
                    </div>
                `, 'success');
                
                // إغلاق النموذج وإعادة تعيينه
                const quickOrderModal = bootstrap.Modal.getInstance(document.getElementById('quickOrderModal'));
                quickOrderModal.hide();
                document.getElementById('quickOrderForm').reset();
                
                // إضافة المنتج إلى السلة
                addToCartFromPage();
                
            } catch (error) {
                console.error('Erreur:', error);
                
                let errorMessage = 'Une erreur inattendue s\'est produite. Veuillez réessayer.';
                if (error.code) {
                    errorMessage = `Erreur système: ${error.code}`;
                } else if (error.message) {
                    errorMessage = error.message;
                } else if (error.text) {
                    errorMessage = error.text;
                }
                
                showStatus(`Erreur lors de l'envoi de la commande: ${errorMessage}`, 'error');
            } finally {
                // إعادة تمكين زر الإرسال
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Confirmer la commande';
            }
        }

        // ============== وظائف مساعدة ==============

        // عرض خطأ المنتج
        function showProductError(message) {
            const container = document.getElementById('productContainer');
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="bi bi-exclamation-triangle display-1 text-danger"></i>
                    <h3 class="mt-3">${message}</h3>
                    <p class="mb-4">Désolé, nous n'avons pas pu trouver le produit demandé.</p>
                    <a href="index.html" class="btn btn-orange btn-lg">
                        <i class="bi bi-arrow-left"></i> Retour à la boutique
                    </a>
                </div>
            `;
        }

        // عرض حالة الطلب
        function showStatus(message, type) {
            const indicator = document.getElementById('statusIndicator');
            const messageElement = document.getElementById('statusMessage');
            
            // إعداد الرسالة
            messageElement.innerHTML = message;
            
            // إعداد التصميم حسب النوع
            const alert = indicator.querySelector('.alert');
            alert.className = 'alert alert-dismissible fade show';
            
            switch (type) {
                case 'success':
                    alert.classList.add('alert-success', 'order-confirmation');
                    break;
                case 'error':
                    alert.classList.add('alert-danger', 'order-error');
                    break;
                case 'info':
                    alert.classList.add('alert-info');
                    break;
                case 'loading':
                    alert.classList.add('alert-info');
                    messageElement.innerHTML = `
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        ${message}
                    `;
                    break;
                default:
                    alert.classList.add('alert-info');
            }
            
            // إظهار المؤشر
            indicator.style.display = 'block';
            
            // إخفاء التلقائي لرسائل النجاح بعد 5 ثواني
            if (type === 'success') {
                setTimeout(hideStatus, 5000);
            }
        }

        // إخفاء مؤشر الحالة
        function hideStatus() {
            document.getElementById('statusIndicator').style.display = 'none';
        }

        // ============== تهيئة الصفحة ==============
        document.addEventListener('DOMContentLoaded', function() {
            // تهيئة وضع الظلام
            initDarkMode();
            
            // تحميل السلة
            loadCart();
            
            // تحميل المنتج
            loadProduct();
            
            // إضافة معالجة الروابط في البطاقات لمنع الانتقال عند النقر على الأزرار
            document.addEventListener('click', function(e) {
                if (e.target.closest('.buy-btn') || 
                    e.target.closest('.action-buttons button')) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
        });
    </script>
</body>
</html>
